#!/bin/sh
# .sh_commons - common settings for shells

#                                  ALIAS                                  {{{1
# ============================================================================

alias pm-hibernate='echo "NEVER USE IT!"'
alias ls='ls -Av --color --group-directories-first'
alias grep='grep --color'
alias du='du -b'
alias o='xdg-open'
alias g='git'
if typeset -f __git_complete > /dev/null; then
  __git_complete g __git_main
fi
alias run='mosh run'
alias mvim='vim -u ~/.vimrc_minimal'

alias vagrant-restart-mysql='vagrant ssh --command "sudo service mysql restart"'
alias vagrant-apache-log='vagrant ssh --command "sudo cat /var/log/apache2/error.log"'

# Disable .vimrc in vim.tiny because of incompatible settings.
if [[ $(which vim.tiny 2> /dev/null) ]]; then
  alias vim.tiny='vim.tiny -u NONE'
fi

# When exiting from Midnight Commander, switch the shell to the current
# directory
if [[ $(which mc 2> /dev/null) ]]; then
  alias mc='. /usr/lib/mc/mc-wrapper.sh'
fi

if [[ $(which nnn 2> /dev/null) ]]; then
  n()
  {
    EDITOR='vim' nnn -dHn "$@"

    export NNN_TMPFILE=${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd

    # cd on quit only on ^G
    if [ -f $NNN_TMPFILE ]; then
            . $NNN_TMPFILE
            rm -f $NNN_TMPFILE > /dev/null
    fi
  }
fi

# Do not close the image after gnuplot.
if [[ $(which gnuplot 2> /dev/null) ]]; then
  alias gnuplot='gnuplot -persist'
fi

#                          ENVIRONMENT VARIABLES                          {{{1
# ============================================================================

# Add ~/bin to $PATH.
if [[ ! $PATH =~ $HOME/bin ]]; then
  export PATH=$HOME/bin:$PATH
fi
if [[ ! $PATH =~ $HOME/.gitconfig_files/custom_commands ]]; then
  export PATH=$HOME/.gitconfig_files/custom_commands:$PATH
fi
if [[ ! $PATH =~ $HOME/src/bash-mosh/bin ]]; then
  export PATH=$HOME/src/bash-mosh/bin:$PATH
fi

if [[ -z $EDITOR ]]; then
  export EDITOR="nvim"
fi

# View manuals in vim.
export MANPAGER="/bin/sh -c \"unset PAGER; col -b -x |         \
                 vim -R                                        \
                 -c 'set nocp'                                 \
                 -c 'filetype plugin on'                       \
                 -c 'syntax enable'                            \
                 -c 'runtime ftplugin/man.vim'                 \
                 -c 'set ft=man ls=0 nosmd nonu nornu nolist'  \
                 -c 'map <CR> <C-]>'                           \
                 -c 'map q :q<CR>' - \""

# FZF default options
export FZF_DEFAULT_OPTS="--exact --multi \
    --bind=tab:accept \
    --bind=ctrl-j:accept \
    --bind=ctrl-space:toggle+down \
    --bind=ctrl-d:page-down \
    --bind=ctrl-u:page-up \
    --bind=ctrl-e:preview-page-down \
    --bind=ctrl-y:preview-page-up \
    --bind=ctrl-w:backward-kill-word \
    --bind=ctrl-a:select-all"

#                                FUNCTIONS                                {{{1
# ============================================================================

# Start program then give back the prompt (to run programs with GUI).
x()
{
  nohup $* &> /dev/null &
}

# Countdown timer
#   $ alarm 1    # Wait 60 seconds
#   $ alarm 1:23 # Wait 83 seconds
alarm()
{
  sleep `TZ=utc date -d "1970-01-01 0:$1" +%s`
  kdialog --passivepopup 'ALARM' 5
  cvlc --repeat /usr/share/sounds/freedesktop/stereo/service-login.oga
}

# English-hungarian dictionary, download:
# https://github.com/BimbaLaszlo/dotvim/blob/master/doc/szotar.txt
szotar()
{
  if [[ -e $HOME/.vim_local/bundle/dotvim/doc/szotar.txt ]]; then
    grep "$@" $HOME/.vim_local/bundle/dotvim/doc/szotar.txt
  else
    echo "ERROR: missing dictionary $HOME/.vim_local/bundle/dotvim/doc/szotar.txt"
  fi
}

cd..() {
  local declare dirs=()
  get_parent_dirs() {
    if [[ -d "${1}" ]]; then dirs+=("$1"); else return; fi
    if [[ "${1}" == '/' ]]; then
      for _dir in "${dirs[@]}"; do echo $_dir; done
    else
      get_parent_dirs $(dirname "$1")
    fi
  }
  local DIR=$(get_parent_dirs "${1:-$PWD}" | tail +2 | fzf --layout=reverse --height="40%")
  cd "$DIR"
}
